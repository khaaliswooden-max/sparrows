<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>THE SPARROWS - Season 2: Training Day (Mobile)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%; height: 100%; overflow: hidden; 
            background: #000; 
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        #gameContainer {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #gameCanvas { 
            background: #000;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        #controls {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 130px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            pointer-events: none;
        }
        .dpad {
            width: 110px; height: 110px;
            position: relative;
            pointer-events: auto;
        }
        .dpad-btn {
            position: absolute;
            width: 36px; height: 36px;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: rgba(255,255,255,0.6);
        }
        .dpad-btn:active, .dpad-btn.active {
            background: rgba(255,255,255,0.35);
        }
        .dpad-up { top: 0; left: 37px; }
        .dpad-down { bottom: 0; left: 37px; }
        .dpad-left { top: 37px; left: 0; }
        .dpad-right { top: 37px; right: 0; }
        .action-btns {
            display: flex; gap: 12px; align-items: center;
            pointer-events: auto;
        }
        .action-btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold;
            color: rgba(255,255,255,0.8);
            font-family: sans-serif;
        }
        .btn-a {
            background: rgba(200,72,72,0.3);
            border: 3px solid rgba(200,72,72,0.6);
        }
        .btn-b {
            background: rgba(72,200,72,0.3);
            border: 3px solid rgba(72,200,72,0.6);
        }
        .action-btn:active, .action-btn.active {
            transform: scale(0.95);
            filter: brightness(1.3);
        }
        #startOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
        }
        #startBtn {
            padding: 20px 40px;
            font-size: 20px;
            background: rgba(200,72,72,0.8);
            border: 3px solid #c84848;
            color: #fff;
            border-radius: 10px;
        }
        .hide { display: none !important; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
    </div>
    
    <div id="controls" class="hide">
        <div class="dpad">
            <div class="dpad-btn dpad-up" data-dir="up">▲</div>
            <div class="dpad-btn dpad-down" data-dir="down">▼</div>
            <div class="dpad-btn dpad-left" data-dir="left">◀</div>
            <div class="dpad-btn dpad-right" data-dir="right">▶</div>
        </div>
        <div class="action-btns">
            <div class="action-btn btn-b" id="btnB">JUMP</div>
            <div class="action-btn btn-a" id="btnA">ATK</div>
        </div>
    </div>
    
    <div id="startOverlay">
        <button id="startBtn">TAP TO START</button>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const controls = document.getElementById('controls');
const startOverlay = document.getElementById('startOverlay');

// NES resolution
const W = 256, H = 224;
let scale = 1;

function resize() {
    const controlsHeight = 130;
    const availH = window.innerHeight - controlsHeight;
    const availW = window.innerWidth;
    scale = Math.min(availW / W, availH / H);
    scale = Math.max(1, scale);
    canvas.width = W * scale;
    canvas.height = H * scale;
    ctx.imageSmoothingEnabled = false;
}
resize();
window.addEventListener('resize', resize);

// NES palette
const COL = {
    bg: '#3c5a8c', sky: '#6888c8', ground: '#8b7355',
    player: '#50b8d8', enemy: '#c84848', platform: '#5c4033',
    text: '#fcfcfc', dark: '#000', ui: '#c84848'
};

// Touch state
const touch = { up: false, down: false, left: false, right: false, a: false, b: false };

// Game state
const ST = { TITLE: 0, SELECT: 1, PLAY: 2, WIN: 3, LOSE: 4, COMPLETE: 5 };
let state = ST.TITLE;
let charIdx = 0;
let mission = 0;
let timer = 0;
let score = 0;

const CHARS = [
    { name: 'CIPHER', col: '#50b8d8' },
    { name: 'VENOM', col: '#58b868' },
    { name: 'HAWK', col: '#d88848' },
    { name: 'ORACLE', col: '#c8a040' }
];

let player = { x: 30, y: 160, w: 14, h: 22, vx: 0, vy: 0, grounded: false, facing: 1, attacking: false, atkTimer: 0 };
let enemies = [];
let platforms = [];
let camera = { x: 0 };
let levelWidth = 800;
let goalX = 750;

function initLevel() {
    player.x = 30; player.y = 160; player.vx = 0; player.vy = 0;
    enemies = [];
    platforms = [];
    camera.x = 0;
    levelWidth = 600 + mission * 200;
    goalX = levelWidth - 50;
    
    // Ground
    platforms.push({ x: 0, y: 190, w: levelWidth, h: 40 });
    
    // Platforms
    for (let i = 0; i < 8 + mission * 2; i++) {
        platforms.push({
            x: 100 + i * 80 + Math.random() * 40,
            y: 100 + Math.random() * 60,
            w: 50 + Math.random() * 30,
            h: 12
        });
    }
    
    // Enemies
    for (let i = 0; i < 4 + mission * 2; i++) {
        enemies.push({
            x: 150 + i * 100 + Math.random() * 50,
            y: 168,
            w: 14, h: 20,
            vx: 0.5 + Math.random() * 0.5,
            dir: 1,
            hp: 1
        });
    }
}

// Touch controls
function setupTouch() {
    const dpadBtns = document.querySelectorAll('.dpad-btn');
    const btnA = document.getElementById('btnA');
    const btnB = document.getElementById('btnB');
    
    dpadBtns.forEach(btn => {
        btn.addEventListener('touchstart', e => {
            e.preventDefault();
            touch[btn.dataset.dir] = true;
            btn.classList.add('active');
        });
        btn.addEventListener('touchend', e => {
            e.preventDefault();
            touch[btn.dataset.dir] = false;
            btn.classList.remove('active');
        });
        btn.addEventListener('touchcancel', e => {
            touch[btn.dataset.dir] = false;
            btn.classList.remove('active');
        });
    });
    
    btnA.addEventListener('touchstart', e => { e.preventDefault(); touch.a = true; btnA.classList.add('active'); });
    btnA.addEventListener('touchend', e => { e.preventDefault(); touch.a = false; btnA.classList.remove('active'); });
    btnB.addEventListener('touchstart', e => { e.preventDefault(); touch.b = true; btnB.classList.add('active'); });
    btnB.addEventListener('touchend', e => { e.preventDefault(); touch.b = false; btnB.classList.remove('active'); });
    
    document.getElementById('startBtn').addEventListener('click', () => {
        startOverlay.classList.add('hide');
        controls.classList.remove('hide');
        state = ST.SELECT;
    });
    
    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        if (state === ST.WIN || state === ST.LOSE) {
            if (state === ST.WIN) {
                mission++;
                if (mission >= 4) state = ST.COMPLETE;
                else { state = ST.PLAY; initLevel(); }
            } else {
                state = ST.PLAY;
                initLevel();
            }
        } else if (state === ST.COMPLETE) {
            state = ST.TITLE;
            mission = 0;
            score = 0;
        }
    });
}
setupTouch();

// Keyboard fallback
const keys = {};
document.addEventListener('keydown', e => keys[e.code] = true);
document.addEventListener('keyup', e => keys[e.code] = false);

function getInput() {
    return {
        left: touch.left || keys['ArrowLeft'] || keys['KeyA'],
        right: touch.right || keys['ArrowRight'] || keys['KeyD'],
        jump: touch.b || keys['Space'] || keys['KeyW'] || keys['ArrowUp'],
        attack: touch.a || keys['KeyX'] || keys['KeyJ']
    };
}

let prevInput = {};

function update() {
    timer++;
    const input = getInput();
    
    switch (state) {
        case ST.TITLE:
            startOverlay.style.display = 'flex';
            break;
            
        case ST.SELECT:
            if (input.left && !prevInput.left) charIdx = (charIdx + 3) % 4;
            if (input.right && !prevInput.right) charIdx = (charIdx + 1) % 4;
            if ((input.jump || input.attack) && !(prevInput.jump || prevInput.attack)) {
                state = ST.PLAY;
                initLevel();
            }
            break;
            
        case ST.PLAY:
            // Player movement
            player.vx = 0;
            if (input.left) { player.vx = -2; player.facing = -1; }
            if (input.right) { player.vx = 2; player.facing = 1; }
            
            // Jump
            if (input.jump && player.grounded) {
                player.vy = -7;
                player.grounded = false;
            }
            
            // Attack
            if (input.attack && !player.attacking) {
                player.attacking = true;
                player.atkTimer = 15;
            }
            if (player.attacking) {
                player.atkTimer--;
                if (player.atkTimer <= 0) player.attacking = false;
            }
            
            // Gravity
            player.vy += 0.35;
            player.x += player.vx;
            player.y += player.vy;
            
            // Platform collision
            player.grounded = false;
            platforms.forEach(p => {
                if (player.x + player.w > p.x && player.x < p.x + p.w) {
                    if (player.y + player.h >= p.y && player.y + player.h <= p.y + 15 && player.vy >= 0) {
                        player.y = p.y - player.h;
                        player.vy = 0;
                        player.grounded = true;
                    }
                }
            });
            
            // Bounds
            player.x = Math.max(0, Math.min(levelWidth - player.w, player.x));
            if (player.y > H + 50) {
                state = ST.LOSE;
            }
            
            // Camera
            camera.x = player.x - W / 3;
            camera.x = Math.max(0, Math.min(levelWidth - W, camera.x));
            
            // Enemies
            enemies.forEach(e => {
                if (e.hp <= 0) return;
                e.x += e.vx * e.dir;
                if (e.x < 20 || e.x > levelWidth - 30) e.dir *= -1;
                
                // Player collision
                if (player.x + player.w > e.x && player.x < e.x + e.w &&
                    player.y + player.h > e.y && player.y < e.y + e.h) {
                    if (player.attacking) {
                        e.hp = 0;
                        score += 100;
                    } else if (player.vy > 0 && player.y + player.h < e.y + 10) {
                        e.hp = 0;
                        player.vy = -5;
                        score += 100;
                    } else {
                        state = ST.LOSE;
                    }
                }
            });
            
            // Goal
            if (player.x >= goalX) {
                state = ST.WIN;
                score += 500;
            }
            break;
    }
    
    prevInput = { ...input };
}

function draw() {
    ctx.fillStyle = COL.sky;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.scale(scale, scale);
    
    switch (state) {
        case ST.TITLE: drawTitle(); break;
        case ST.SELECT: drawSelect(); break;
        case ST.PLAY: drawGame(); break;
        case ST.WIN: drawWin(); break;
        case ST.LOSE: drawLose(); break;
        case ST.COMPLETE: drawComplete(); break;
    }
    
    ctx.restore();
}

function drawTitle() {
    ctx.fillStyle = COL.text;
    ctx.font = 'bold 16px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('THE SPARROWS', W/2, 60);
    ctx.font = '12px monospace';
    ctx.fillText('SEASON 2', W/2, 80);
    ctx.fillStyle = COL.ui;
    ctx.fillText('TRAINING DAY', W/2, 100);
    
    for (let i = 0; i < 4; i++) {
        ctx.fillStyle = CHARS[i].col;
        ctx.fillRect(70 + i * 35, 120, 14, 22);
    }
    
    ctx.fillStyle = COL.text;
    ctx.font = '10px monospace';
    if (timer % 60 < 40) ctx.fillText('TAP TO START', W/2, 180);
}

function drawSelect() {
    ctx.fillStyle = COL.text;
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('SELECT OPERATIVE', W/2, 40);
    
    for (let i = 0; i < 4; i++) {
        const sel = i === charIdx;
        if (sel) {
            ctx.fillStyle = COL.text;
            ctx.fillRect(55 + i * 45 - 3, 67, 26, 42);
        }
        ctx.fillStyle = CHARS[i].col;
        ctx.fillRect(55 + i * 45, 70, 20, 36);
        
        if (sel) {
            ctx.fillStyle = COL.text;
            ctx.font = '10px monospace';
            ctx.fillText(CHARS[i].name, W/2, 130);
        }
    }
    
    ctx.fillStyle = COL.ui;
    ctx.font = '10px monospace';
    ctx.fillText('< SELECT >', W/2, 160);
    ctx.fillText('TAP JUMP TO START', W/2, 180);
}

function drawGame() {
    ctx.save();
    ctx.translate(-camera.x, 0);
    
    // Platforms
    ctx.fillStyle = COL.platform;
    platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
    
    // Goal
    ctx.fillStyle = '#48c848';
    ctx.fillRect(goalX, 150, 20, 40);
    ctx.fillStyle = COL.text;
    ctx.font = '8px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('GOAL', goalX + 10, 145);
    
    // Enemies
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        ctx.fillStyle = COL.enemy;
        ctx.fillRect(e.x, e.y, e.w, e.h);
    });
    
    // Player
    ctx.fillStyle = CHARS[charIdx].col;
    ctx.fillRect(player.x, player.y, player.w, player.h);
    
    // Attack
    if (player.attacking) {
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        const atkX = player.facing > 0 ? player.x + player.w : player.x - 15;
        ctx.fillRect(atkX, player.y + 5, 15, 10);
    }
    
    ctx.restore();
    
    // UI
    ctx.fillStyle = COL.dark;
    ctx.fillRect(0, 0, W, 20);
    ctx.fillStyle = COL.text;
    ctx.font = '10px monospace';
    ctx.textAlign = 'left';
    ctx.fillText('M' + (mission + 1) + ' ' + CHARS[charIdx].name, 5, 14);
    ctx.textAlign = 'right';
    ctx.fillText('SCORE: ' + score, W - 5, 14);
}

function drawWin() {
    ctx.fillStyle = '#48c848';
    ctx.font = 'bold 16px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('STAGE CLEAR!', W/2, 90);
    ctx.fillStyle = COL.text;
    ctx.font = '12px monospace';
    ctx.fillText('SCORE: ' + score, W/2, 120);
    ctx.font = '10px monospace';
    if (timer % 60 < 40) ctx.fillText('TAP TO CONTINUE', W/2, 160);
}

function drawLose() {
    ctx.fillStyle = COL.enemy;
    ctx.font = 'bold 16px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('GAME OVER', W/2, 90);
    ctx.fillStyle = COL.text;
    ctx.font = '10px monospace';
    if (timer % 60 < 40) ctx.fillText('TAP TO RETRY', W/2, 140);
}

function drawComplete() {
    ctx.fillStyle = COL.text;
    ctx.font = 'bold 14px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('SEASON 2 COMPLETE', W/2, 60);
    ctx.font = '10px monospace';
    ctx.fillText('TRAINING COMPLETE', W/2, 90);
    ctx.fillText('THE REAL MISSIONS BEGIN...', W/2, 110);
    ctx.fillText('SCORE: ' + score, W/2, 140);
    
    for (let i = 0; i < 4; i++) {
        ctx.fillStyle = CHARS[i].col;
        ctx.fillRect(70 + i * 35, 155, 14, 22);
    }
    
    if (timer % 60 < 40) ctx.fillText('TAP FOR MENU', W/2, 205);
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
