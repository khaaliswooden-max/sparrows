<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>THE SPARROWS - Season 5: Scattered (Mobile)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; touch-action: none; user-select: none; }
        #gameCanvas { display: block; }
        #controls {
            position: fixed; bottom: 0; left: 0; right: 0; height: 130px;
            display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;
        }
        #joystick {
            width: 100px; height: 100px;
            background: rgba(72,200,136,0.2);
            border: 2px solid rgba(72,200,136,0.4);
            border-radius: 50%; position: relative;
        }
        #joystickKnob {
            width: 40px; height: 40px;
            background: rgba(72,200,136,0.6);
            border-radius: 50%; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .action-btns { display: flex; gap: 12px; align-items: center; }
        .action-btn {
            width: 55px; height: 55px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: bold; color: rgba(255,255,255,0.9);
            font-family: sans-serif;
        }
        .btn-shoot { background: rgba(200,72,72,0.4); border: 3px solid rgba(200,72,72,0.7); width: 65px; height: 65px; }
        .btn-vision { background: rgba(72,200,200,0.3); border: 2px solid rgba(72,200,200,0.6); width: 50px; height: 50px; }
        .action-btn.active { filter: brightness(1.4); }
        #startOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        #startBtn { padding: 20px 40px; font-size: 18px; background: rgba(72,200,136,0.8); border: 3px solid #48c888; color: #fff; border-radius: 10px; }
        .hide { display: none !important; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="controls" class="hide">
        <div id="joystick"><div id="joystickKnob"></div></div>
        <div class="action-btns">
            <div class="action-btn btn-vision" id="btnVision">VISION</div>
            <div class="action-btn btn-shoot" id="btnShoot">FIRE</div>
        </div>
    </div>
    
    <div id="startOverlay">
        <button id="startBtn">TAP TO START</button>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const W = 400, H = 240;
let scale = 1;

function resize() {
    const ch = 130;
    const ah = window.innerHeight - ch;
    scale = Math.min(window.innerWidth / W, ah / H);
    canvas.width = W * scale;
    canvas.height = H * scale;
    canvas.style.marginTop = Math.max(0, (ah - H * scale) / 2) + 'px';
}
resize();
window.addEventListener('resize', resize);

const COL = { bg: '#0a1a0a', floor: '#1a2a1a', wall: '#2a3a2a', enemy: '#c84848', text: '#f0f0f0', gold: '#d4a050', green: '#48c888' };

const joy = { x: 0, y: 0, active: false };
const touch = { shoot: false, vision: false };
const ST = { TITLE: 0, SELECT: 1, PLAY: 2, WIN: 3, LOSE: 4, DONE: 5 };
let state = ST.TITLE, charIdx = 0, mission = 0, timer = 0;

const CHARS = [
    { name: 'CIPHER', col: '#50b8d8' },
    { name: 'VENOM', col: '#58b868' },
    { name: 'HAWK', col: '#d88848' },
    { name: 'ORACLE', col: '#c8a040' }
];

let player = { x: 50, y: 120, w: 16, h: 24, hp: 100, ammo: 30, face: 1, shootCD: 0 };
let enemies = [], bullets = [], particles = [], camera = { x: 0 }, lvlW = 800;
let visionMode = false, autoTarget = null;

function initLevel() {
    player.x = 50; player.y = 120; player.hp = 100; player.ammo = 30; player.shootCD = 0;
    enemies = []; bullets = []; particles = []; camera.x = 0;
    lvlW = 700 + mission * 200;
    visionMode = false; autoTarget = null;
    
    for (let i = 0; i < 6 + mission * 2; i++) {
        enemies.push({
            x: 180 + i * 80 + Math.random() * 40,
            y: 80 + Math.random() * 100,
            w: 14, h: 22, hp: 2, mhp: 2,
            vx: 0.5, dir: Math.random() > 0.5 ? 1 : -1,
            shootCD: 60 + Math.random() * 60
        });
    }
}

function findTarget() {
    let best = null, bestDist = 200;
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        const dx = e.x - player.x, dy = e.y - player.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const inFront = (player.face > 0 && dx > 0) || (player.face < 0 && dx < 0);
        if (dist < bestDist && inFront) { bestDist = dist; best = e; }
    });
    return best;
}

// Joystick
const joystickEl = document.getElementById('joystick');
const knob = document.getElementById('joystickKnob');
let joyRect = null;

function updateJoy(tx, ty) {
    if (!joyRect) joyRect = joystickEl.getBoundingClientRect();
    const cx = joyRect.left + joyRect.width / 2;
    const cy = joyRect.top + joyRect.height / 2;
    let dx = tx - cx, dy = ty - cy;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const maxD = joyRect.width / 2 - 20;
    if (dist > maxD) { dx = dx / dist * maxD; dy = dy / dist * maxD; }
    knob.style.left = (50 + dx / maxD * 30) + '%';
    knob.style.top = (50 + dy / maxD * 30) + '%';
    joy.x = dx / maxD; joy.y = dy / maxD;
}

joystickEl.addEventListener('touchstart', e => { e.preventDefault(); joy.active = true; joyRect = joystickEl.getBoundingClientRect(); updateJoy(e.touches[0].clientX, e.touches[0].clientY); });
joystickEl.addEventListener('touchmove', e => { e.preventDefault(); if (joy.active) updateJoy(e.touches[0].clientX, e.touches[0].clientY); });
joystickEl.addEventListener('touchend', e => { e.preventDefault(); joy.active = false; joy.x = 0; joy.y = 0; knob.style.left = '50%'; knob.style.top = '50%'; });

document.getElementById('btnShoot').addEventListener('touchstart', e => { e.preventDefault(); touch.shoot = true; e.target.classList.add('active'); });
document.getElementById('btnShoot').addEventListener('touchend', e => { e.preventDefault(); touch.shoot = false; e.target.classList.remove('active'); });
document.getElementById('btnVision').addEventListener('touchstart', e => { e.preventDefault(); touch.vision = true; e.target.classList.add('active'); visionMode = !visionMode; });
document.getElementById('btnVision').addEventListener('touchend', e => { e.preventDefault(); touch.vision = false; e.target.classList.remove('active'); });

document.getElementById('startBtn').addEventListener('click', () => {
    document.getElementById('startOverlay').classList.add('hide');
    document.getElementById('controls').classList.remove('hide');
    state = ST.SELECT;
});

canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    if (state === ST.WIN) { mission++; state = mission >= 4 ? ST.DONE : ST.PLAY; if (state === ST.PLAY) initLevel(); }
    else if (state === ST.LOSE) { state = ST.PLAY; initLevel(); }
    else if (state === ST.DONE) { state = ST.TITLE; mission = 0; }
});

const keys = {};
document.addEventListener('keydown', e => keys[e.code] = true);
document.addEventListener('keyup', e => keys[e.code] = false);

let pShoot = false;
function update() {
    timer++;
    
    if (state === ST.SELECT) {
        if (joy.x < -0.5 && timer % 12 === 0) charIdx = (charIdx + 3) % 4;
        if (joy.x > 0.5 && timer % 12 === 0) charIdx = (charIdx + 1) % 4;
        if (touch.shoot && !pShoot) { state = ST.PLAY; initLevel(); }
    }
    
    if (state === ST.PLAY) {
        const spd = 2.2;
        player.x += joy.x * spd;
        player.y += joy.y * spd;
        if (joy.x !== 0) player.face = joy.x > 0 ? 1 : -1;
        
        player.x = Math.max(10, Math.min(lvlW - player.w - 10, player.x));
        player.y = Math.max(30, Math.min(H - player.h - 10, player.y));
        
        camera.x = player.x - W / 3;
        camera.x = Math.max(0, Math.min(lvlW - W, camera.x));
        
        autoTarget = findTarget();
        
        if (player.shootCD > 0) player.shootCD--;
        
        if (touch.shoot && player.shootCD <= 0 && player.ammo > 0) {
            player.shootCD = 8;
            player.ammo--;
            
            let tx = player.x + player.face * 200, ty = player.y + player.h / 2;
            if (autoTarget) { tx = autoTarget.x + autoTarget.w / 2; ty = autoTarget.y + autoTarget.h / 2; }
            
            const dx = tx - player.x, dy = ty - (player.y + player.h / 2);
            const dist = Math.sqrt(dx * dx + dy * dy);
            bullets.push({
                x: player.x + player.w / 2, y: player.y + player.h / 2,
                vx: dx / dist * 8, vy: dy / dist * 8, owner: 'player'
            });
            
            for (let i = 0; i < 3; i++) particles.push({ x: player.x + player.w/2, y: player.y + player.h/2, vx: player.face * 2 + Math.random(), vy: (Math.random() - 0.5) * 2, life: 10, col: '#ff0' });
        }
        
        // Enemies
        enemies.forEach(e => {
            if (e.hp <= 0) return;
            
            e.x += e.vx * e.dir;
            if (e.x < 50 || e.x > lvlW - 50) e.dir *= -1;
            
            const dx = player.x - e.x;
            if (Math.abs(dx) < 180) {
                e.dir = dx > 0 ? 1 : -1;
                e.shootCD--;
                if (e.shootCD <= 0) {
                    e.shootCD = 80 + Math.random() * 40;
                    const dy = player.y - e.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    bullets.push({ x: e.x + e.w/2, y: e.y + e.h/2, vx: dx/dist * 4, vy: dy/dist * 4, owner: 'enemy' });
                }
            }
        });
        
        // Bullets
        bullets = bullets.filter(b => {
            b.x += b.vx; b.y += b.vy;
            if (b.x < camera.x - 50 || b.x > camera.x + W + 50) return false;
            
            if (b.owner === 'player') {
                enemies.forEach(e => {
                    if (e.hp <= 0) return;
                    if (b.x > e.x && b.x < e.x + e.w && b.y > e.y && b.y < e.y + e.h) {
                        e.hp--;
                        b.vx = 0; b.vy = 0;
                        for (let i = 0; i < 5; i++) particles.push({ x: b.x, y: b.y, vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*3, life: 15, col: '#f00' });
                    }
                });
            } else {
                if (b.x > player.x && b.x < player.x + player.w && b.y > player.y && b.y < player.y + player.h) {
                    player.hp -= 12;
                    b.vx = 0;
                    if (player.hp <= 0) state = ST.LOSE;
                }
            }
            return b.vx !== 0;
        });
        
        particles = particles.filter(p => { p.x += p.vx; p.y += p.vy; p.life--; return p.life > 0; });
        
        if (enemies.every(e => e.hp <= 0)) state = ST.WIN;
    }
    
    pShoot = touch.shoot;
}

function draw() {
    ctx.fillStyle = visionMode ? '#001a00' : COL.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.scale(scale, scale);
    
    if (state === ST.TITLE) drawTitle();
    else if (state === ST.SELECT) drawSelect();
    else if (state === ST.PLAY) drawGame();
    else if (state === ST.WIN) drawWin();
    else if (state === ST.LOSE) drawLose();
    else if (state === ST.DONE) drawDone();
    
    ctx.restore();
}

function drawTitle() {
    ctx.fillStyle = COL.gold;
    ctx.font = 'bold 20px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('THE SPARROWS', W/2, 55);
    ctx.font = '14px sans-serif';
    ctx.fillStyle = COL.green;
    ctx.fillText('SEASON 5', W/2, 75);
    ctx.fillStyle = COL.text;
    ctx.fillText('SCATTERED', W/2, 95);
    for (let i = 0; i < 4; i++) { ctx.fillStyle = CHARS[i].col; ctx.fillRect(130 + i * 40, 115, 16, 24); }
    ctx.fillStyle = COL.gold;
    if (timer % 60 < 40) ctx.fillText('TAP TO START', W/2, 185);
}

function drawSelect() {
    ctx.fillStyle = COL.text;
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('SELECT OPERATIVE', W/2, 40);
    for (let i = 0; i < 4; i++) {
        const sel = i === charIdx;
        if (sel) { ctx.fillStyle = COL.gold; ctx.fillRect(110 + i * 50 - 3, 57, 30, 44); }
        ctx.fillStyle = CHARS[i].col;
        ctx.fillRect(110 + i * 50, 60, 24, 38);
        if (sel) { ctx.fillStyle = COL.text; ctx.fillText(CHARS[i].name, W/2, 120); }
    }
    ctx.fillStyle = COL.green;
    ctx.font = '10px sans-serif';
    ctx.fillText('TAP FIRE TO START', W/2, 170);
}

function drawGame() {
    ctx.save();
    ctx.translate(-camera.x, 0);
    
    ctx.fillStyle = COL.floor;
    ctx.fillRect(0, 0, lvlW, H);
    
    // Grid for vision mode
    if (visionMode) {
        ctx.strokeStyle = '#0f02';
        ctx.lineWidth = 1;
        for (let x = 0; x < lvlW; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
        for (let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(lvlW, y); ctx.stroke(); }
    }
    
    // Enemies
    enemies.forEach(e => {
        if (e.hp <= 0) return;
        ctx.fillStyle = visionMode ? '#0f0' : COL.enemy;
        ctx.fillRect(e.x, e.y, e.w, e.h);
        
        if (e === autoTarget) {
            ctx.strokeStyle = '#ff0';
            ctx.lineWidth = 2;
            ctx.strokeRect(e.x - 3, e.y - 3, e.w + 6, e.h + 6);
            ctx.fillStyle = '#ff0';
            ctx.font = '8px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('TARGET', e.x + e.w/2, e.y - 8);
        }
        
        ctx.fillStyle = '#300';
        ctx.fillRect(e.x, e.y - 6, e.w, 3);
        ctx.fillStyle = '#f00';
        ctx.fillRect(e.x, e.y - 6, e.w * (e.hp / e.mhp), 3);
    });
    
    // Player
    ctx.fillStyle = CHARS[charIdx].col;
    ctx.fillRect(player.x, player.y, player.w, player.h);
    
    // Bullets
    bullets.forEach(b => {
        ctx.fillStyle = b.owner === 'player' ? '#ff0' : '#f44';
        ctx.fillRect(b.x - 3, b.y - 1, 6, 2);
    });
    
    // Particles
    particles.forEach(p => {
        ctx.fillStyle = p.col;
        ctx.globalAlpha = p.life / 15;
        ctx.fillRect(p.x - 1, p.y - 1, 3, 3);
    });
    ctx.globalAlpha = 1;
    
    // Auto-aim line
    if (autoTarget && touch.shoot) {
        ctx.strokeStyle = '#ff04';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(player.x + player.w/2, player.y + player.h/2);
        ctx.lineTo(autoTarget.x + autoTarget.w/2, autoTarget.y + autoTarget.h/2);
        ctx.stroke();
        ctx.setLineDash([]);
    }
    
    ctx.restore();
    
    // UI
    ctx.fillStyle = '#000c';
    ctx.fillRect(0, 0, W, 24);
    
    ctx.fillStyle = COL.text;
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(CHARS[charIdx].name, 8, 16);
    
    ctx.fillStyle = '#300';
    ctx.fillRect(80, 8, 80, 8);
    ctx.fillStyle = player.hp > 30 ? '#0c0' : '#c00';
    ctx.fillRect(80, 8, 80 * (player.hp / 100), 8);
    
    ctx.fillStyle = COL.gold;
    ctx.textAlign = 'right';
    ctx.fillText('AMMO: ' + player.ammo, W - 8, 16);
    
    if (visionMode) {
        ctx.fillStyle = '#0f0';
        ctx.font = '8px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('[ THERMAL VISION ]', W/2, 16);
    }
    
    const rem = enemies.filter(e => e.hp > 0).length;
    ctx.fillStyle = COL.text;
    ctx.textAlign = 'center';
    ctx.fillText('HOSTILES: ' + rem, W/2, H - 8);
}

function drawWin() {
    ctx.fillStyle = '#48c848';
    ctx.font = 'bold 18px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('AREA CLEAR', W/2, 90);
    ctx.fillStyle = COL.text;
    ctx.font = '11px sans-serif';
    if (timer % 60 < 40) ctx.fillText('TAP TO CONTINUE', W/2, 140);
}

function drawLose() {
    ctx.fillStyle = COL.enemy;
    ctx.font = 'bold 18px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('KIA', W/2, 95);
    ctx.fillStyle = COL.text;
    ctx.font = '11px sans-serif';
    if (timer % 60 < 40) ctx.fillText('TAP TO RETRY', W/2, 140);
}

function drawDone() {
    ctx.fillStyle = COL.gold;
    ctx.font = 'bold 16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('SEASON 5 COMPLETE', W/2, 55);
    ctx.fillStyle = COL.text;
    ctx.font = '10px sans-serif';
    ctx.fillText('SCATTERED BUT NOT BROKEN', W/2, 85);
    ctx.fillText('THE SPARROWS REUNITE', W/2, 100);
    ctx.fillText('FOR THE FINAL BATTLE', W/2, 120);
    for (let i = 0; i < 4; i++) { ctx.fillStyle = CHARS[i].col; ctx.fillRect(130 + i * 40, 140, 16, 24); }
    if (timer % 60 < 40) ctx.fillText('TAP FOR MENU', W/2, 200);
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
